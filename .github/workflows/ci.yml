name: CI

on:
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Release, Debug]
        
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake
    
    - name: Configure CMake
      run: |
        echo "========================================="
        echo "Building CPU-only version (no GPU offload)"
        echo "========================================="
        echo ""
        echo "Note: This CI workflow tests CPU-only builds."
        echo "GPU offload is tested separately in gpu-ci.yml workflow."
        echo ""
        mkdir -p build
        cd build
        # Suppress unused variable warnings (common in GPU-only code paths and assertions)
        export CXXFLAGS="-Wno-unused-variable -Wno-unused-but-set-variable"
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
    
    - name: Build
      run: |
        cd build
        make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
    
    - name: Run Tests
      run: |
        cd build
        ctest --output-on-failure
    
    - name: Physics Validation Tests
      run: |
        cd build
        echo "========================================="
        echo "Physics Validation (CPU)"
        echo "========================================="
        echo ""
        echo "Running comprehensive N-S equation validation:"
        echo "  • Poiseuille analytical solution"
        echo "  • Divergence-free constraint"
        echo "  • Momentum balance"
        echo "  • Channel symmetry"
        echo "  • Cross-model consistency"
        echo "  • Taylor-Green vortex decay"
        echo ""
        
        ./test_physics_validation || {
          echo ""
          echo "❌ Physics validation failed!"
          echo "Solver may not correctly solve Navier-Stokes equations."
          exit 1
        }
        
        echo ""
        echo "Running Taylor-Green vortex validation..."
        ./test_tg_validation || {
          echo ""
          echo "❌ Taylor-Green validation failed!"
          exit 1
        }
        
        echo ""
        echo "✅ All physics validation tests passed on CPU!"
    
    - name: Test turbulence models (CPU)
      run: |
        cd build
        mkdir -p output/ci_validation
        chmod +x ../.github/scripts/validate_turbulence_model.sh
        
        echo "=== Testing all turbulence models on CPU ==="
        echo ""
        
        # Test each model and validate output
        test_model() {
            local MODEL=$1
            local NAME=$2
            local MAX_ITER=${3:-50}
            
            echo "$NAME:"
            ./channel --Nx 64 --Ny 128 --nu 0.001 --max_iter $MAX_ITER \
                     --model $MODEL --dp_dx -0.01 \
                     --output output/ci_validation/test_${MODEL} --num_snapshots 0 --quiet
            
            # Validate output
            ../.github/scripts/validate_turbulence_model.sh "$NAME" "output/ci_validation"
            echo ""
        }
        
        echo "--- Algebraic Models ---"
        test_model "baseline" "1. Baseline mixing length" 50
        test_model "gep" "2. GEP model" 50
        
        echo "--- Transport Equation Models ---"
        test_model "sst" "3. SST k-omega" 100
        test_model "komega" "4. k-omega (Wilcox)" 100
        
        echo "--- EARSM Models ---"
        test_model "earsm_wj" "5. Wallin-Johansson EARSM" 100
        test_model "earsm_gs" "6. Gatski-Speziale EARSM" 100
        test_model "earsm_pope" "7. Pope Quadratic EARSM" 100
        
        echo "=== All turbulence models validated on CPU ==="
    
    - name: Check for warnings
      if: matrix.build_type == 'Release'
      run: |
        cd build
        export CXXFLAGS="-Wno-unused-variable -Wno-unused-but-set-variable"
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make clean
        make 2>&1 | tee build.log
        # Check for warnings but exclude unused variable warnings (GPU-only code paths)
        if grep -i "warning:" build.log | grep -v "unused-variable" | grep -v "unused-but-set-variable"; then
          echo "Warnings detected (excluding unused-variable warnings)!"
          exit 1
        fi
        echo "No warnings detected (unused-variable warnings excluded)"

