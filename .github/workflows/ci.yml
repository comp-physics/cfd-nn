name: CI

on:
  push:

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        build_type: [Release, Debug]

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Build and Test (CPU-only)
      run: |
        echo "========================================="
        echo "Building and testing CPU-only version"
        echo "========================================="
        echo ""
        echo "Note: This CI workflow tests CPU-only builds."
        echo "GPU offload is tested separately in gpu-ci.yml workflow."
        echo ""

        # Build with specified build type
        mkdir -p build_cpu
        cd build_cpu
        # Suppress unused variable warnings (common in GPU-only code paths)
        export CXXFLAGS="-Wno-unused-variable -Wno-unused-but-set-variable"
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DUSE_GPU_OFFLOAD=OFF -DBUILD_TESTS=ON
        make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
        cd ..

        # Run the CI test suite
        chmod +x scripts/ci.sh
        chmod +x scripts/check_code_sharing.sh
        ./scripts/ci.sh --cpu

    - name: Check for warnings
      if: matrix.build_type == 'Release'
      run: |
        cd build_cpu
        export CXXFLAGS="-Wno-unused-variable -Wno-unused-but-set-variable"
        cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GPU_OFFLOAD=OFF
        make clean
        make 2>&1 | tee build.log
        # Check for warnings but exclude unused variable warnings (GPU-only code paths)
        if grep -i "warning:" build.log | grep -v "unused-variable" | grep -v "unused-but-set-variable"; then
          echo "Warnings detected (excluding unused-variable warnings)!"
          exit 1
        fi
        echo "No warnings detected (unused-variable warnings excluded)"
