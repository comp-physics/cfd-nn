name: GPU CI

on:
  push:

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 150
    # Prevent concurrent cache saves from colliding (prefix-match restores set cache-hit=false)
    concurrency:
      group: gpu-ci-cache-${{ github.ref }}
      cancel-in-progress: false

    steps:
    - uses: actions/checkout@v4

    # Extract HYPRE version from CMakeLists.txt to ensure cache key stays in sync
    - name: Extract HYPRE version
      id: hypre_version
      run: |
        HYPRE_VERSION=$(grep -oP 'GIT_TAG v\K[\d.]+' CMakeLists.txt)
        if [ -z "$HYPRE_VERSION" ]; then
          echo "ERROR: Could not extract HYPRE version from CMakeLists.txt"
          echo "Expected pattern: GIT_TAG v<version>"
          exit 1
        fi
        echo "version=${HYPRE_VERSION}" >> $GITHUB_OUTPUT
        echo "Detected HYPRE version: ${HYPRE_VERSION}"

    # Restore HYPRE cache (slow to compile, rarely changes)
    # Key includes HYPRE version and hash of build config files
    # Only cache *_hypre directories - ci.sh uses these when HYPRE is enabled
    - name: Restore HYPRE cache
      id: hypre_cache
      uses: actions/cache/restore@v4
      with:
        path: |
          build_cpu_hypre/_deps
          build_gpu_hypre/_deps
        key: hypre-v${{ steps.hypre_version.outputs.version }}-h200-cc90-${{ hashFiles('CMakeLists.txt', 'cmake/**', '.github/scripts/**') }}
        restore-keys: |
          hypre-v${{ steps.hypre_version.outputs.version }}-h200-cc90-

    # Clean hypre-subbuild after cache restore - these contain CMakeCache.txt with
    # absolute paths that break when restored on a different runner
    - name: Clean HYPRE subbuild cache (path-sensitive)
      run: |
        echo "Cleaning hypre-subbuild directories (contain absolute paths)..."
        for dir in build_cpu_hypre/_deps build_gpu_hypre/_deps; do
          if [ -d "${dir}/hypre-subbuild" ]; then
            echo "  Removing ${dir}/hypre-subbuild"
            rm -rf "${dir}/hypre-subbuild"
          fi
        done
        echo "Done - hypre-build (compiled libs) preserved, hypre-subbuild (CMake config) cleared"

    - name: Submit GPU correctness suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_correctness.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch"

    - name: Show Build Output
      if: always()
      run: |
        echo "==================================================================="
        echo "  GPU CI Build Log (last 300 lines)"
        echo "==================================================================="
        echo ""
        if [ -f "${GITHUB_WORKSPACE}/gpu_ci_build.log" ]; then
          tail -n 300 "${GITHUB_WORKSPACE}/gpu_ci_build.log"
        else
          echo "Build log not found (build may have failed early)"
          echo "Check the Slurm output for details."
        fi

    - name: Show Test Output
      if: always()
      run: |
        echo "==================================================================="
        echo "  GPU CI Test Log (last 300 lines)"
        echo "==================================================================="
        echo ""
        if [ -f "${GITHUB_WORKSPACE}/gpu_ci_test.log" ]; then
          tail -n 300 "${GITHUB_WORKSPACE}/gpu_ci_test.log"
        else
          echo "Test log not found (tests may not have run)"
          echo "Check the build log and Slurm output for details."
        fi

    - name: Submit GPU performance suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_perf.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch"

    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Commit: $(git rev-parse HEAD)"
        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
        echo ""
        echo "=== Build directories ==="
        ls -la build_gpu_hypre 2>/dev/null || echo "No build_gpu_hypre directory"
        ls -la build_cpu_hypre 2>/dev/null || echo "No build_cpu_hypre directory"
        echo ""
        echo "=== HYPRE cache status ==="
        ls -la build_gpu_hypre/_deps 2>/dev/null || echo "No GPU HYPRE cache"
        ls -la build_cpu_hypre/_deps 2>/dev/null || echo "No CPU HYPRE cache"
        echo ""
        echo "=== Test binaries ==="
        ls -lh build_gpu_hypre/test_* 2>/dev/null || echo "No test binaries found"

    # Save HYPRE cache only on cache miss (HYPRE builds are expensive)
    # Skip if cache was restored with exact key match (cache-hit=true)
    # Concurrency group above prevents parallel saves from colliding
    - name: Save HYPRE cache
      if: always() && steps.hypre_cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          build_cpu_hypre/_deps
          build_gpu_hypre/_deps
        key: hypre-v${{ steps.hypre_version.outputs.version }}-h200-cc90-${{ hashFiles('CMakeLists.txt', 'cmake/**', '.github/scripts/**') }}

    - name: Cleanup
      if: always()
      run: |
        # Clean up Slurm artifacts and logs
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_build.log" || true
        rm -f "${GITHUB_WORKSPACE}/gpu_ci_test.log" || true
        # Clean build artifacts but keep _deps for cache (only *_hypre dirs are cached)
        for dir in build_gpu_hypre build_cpu_hypre; do
          if [ -d "${GITHUB_WORKSPACE}/${dir}" ]; then
            find "${GITHUB_WORKSPACE}/${dir}" -mindepth 1 -maxdepth 1 ! -name '_deps' -exec rm -rf {} +
          fi
        done
        # Fully remove non-hypre build dirs (not cached)
        rm -rf "${GITHUB_WORKSPACE}/build_gpu" "${GITHUB_WORKSPACE}/build_cpu" || true
