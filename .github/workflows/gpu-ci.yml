name: GPU CI

on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 90
    
    steps:
    - name: Clean workspace
      run: |
        echo "Cleaning workspace to avoid stale artifacts..."
        rm -rf ${GITHUB_WORKSPACE}/build_*
        rm -rf ${GITHUB_WORKSPACE}/CMakeCache.txt
        rm -rf ${GITHUB_WORKSPACE}/CMakeFiles
        echo "Workspace cleaned"
    
    - uses: actions/checkout@v3
    
    - name: Verify critical GPU fixes are present in source
      run: |
        echo "========================================="
        echo "Verifying Critical GPU Fixes (Dec 8, 2024)"
        echo "========================================="
        echo ""
        echo "These checks prevent regression of 4 critical bugs that would"
        echo "cause incorrect results when comparing CPU vs GPU runs."
        echo ""
        
        # Check Fix #1: Stride-based indexing in turbulence models
        echo "Fix #1: Stride-based indexing in turbulence models"
        if grep -q "int i = idx % Nx + 1.*skip ghost" src/turbulence_transport.cpp; then
          echo "  ✓ Found stride-based indexing in turbulence_transport.cpp"
        else
          echo "  ✗ MISSING stride-based indexing in turbulence_transport.cpp!"
          echo "     Bug would cause wrong array indexing on GPU (100% wrong results)"
          exit 1
        fi
        
        if grep -q "int cell_idx = j \* stride + i.*Stride-based index" src/turbulence_gep.cpp; then
          echo "  ✓ Found stride-based indexing in turbulence_gep.cpp"
        else
          echo "  ✗ MISSING stride-based indexing in turbulence_gep.cpp!"
          exit 1
        fi
        
        # Check Fix #2: GPU sync after transport equation updates
        echo ""
        echo "Fix #2: GPU sync after transport equation updates"
        if grep -A5 "advance_turbulence" src/solver.cpp | grep -q "target update to.*k_ptr_"; then
          echo "  ✓ Found GPU sync after advance_turbulence()"
        else
          echo "  ✗ MISSING GPU sync after transport equation updates!"
          echo "     Bug would cause stale data in SST/k-omega models (divergence)"
          exit 1
        fi
        
        # Check Fix #3: Correct map sizes with total_size
        echo ""
        echo "Fix #3: Correct map clause sizes (total_size for arrays with ghosts)"
        if grep -q "map(present:.*total_size" src/turbulence_transport.cpp; then
          echo "  ✓ Found correct map size (total_size) in turbulence_transport.cpp"
        else
          echo "  ✗ MISSING correct map size!"
          echo "     Bug would cause size mismatch in GPU mapping"
          exit 1
        fi
        
        # Check Fix #4: Original memory fix (k_ptr_, omega_ptr_)
        echo ""
        echo "Fix #4: GPU memory pointers (k_ptr_, omega_ptr_)"
        if grep -q "double\* k_ptr_" include/solver.hpp && grep -q "double\* omega_ptr_" include/solver.hpp; then
          echo "  ✓ Found k_ptr_ and omega_ptr_ declarations"
        else
          echo "  ✗ MISSING GPU pointer declarations!"
          exit 1
        fi
        
        if grep -q "k_ptr_ = k_.data().data()" src/solver.cpp; then
          echo "  ✓ Found k_ptr_ initialization"
        else
          echo "  ✗ MISSING k_ptr_ initialization!"
          exit 1
        fi
        
        echo ""
        echo "✅ All 4 critical GPU fixes verified in source code"
        echo ""
    
    - name: Make scripts executable
      run: |
        chmod +x scripts/run_gpu_ci_test.sh
        chmod +x .github/scripts/*.sh
    
    - name: Build GPU version
      run: |
        module load nvhpc/25.5
        rm -rf build_ci_gpu
        mkdir -p build_ci_gpu
        cd build_ci_gpu
        echo "=== CMake Configuration ==="
        CC=nvc CXX=nvc++ cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GPU_OFFLOAD=ON 2>&1 | tee cmake_config.log
        echo ""
        echo "=== CMake Configuration Summary ==="
        grep -E "GPU offload|CXX compiler|OpenMP|NVIDIA" cmake_config.log || echo "No GPU-related config found"
        echo ""
        echo "=== Building ==="
        make -j8
        mkdir -p output
    
    - name: Comprehensive GPU tests
      run: |
        cd build_ci_gpu
        ../scripts/run_gpu_ci_test.sh "all_gpu_tests" \
          "bash -c '\
            chmod +x ../.github/scripts/*.sh && \
            mkdir -p output/gpu_validation && \
            echo \"======================================\" && \
            echo \"1. Unit Tests\" && \
            echo \"======================================\" && \
            ctest --output-on-failure && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"2. Algebraic Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh baseline \"Baseline\" 256 512 200000 output/gpu_validation/baseline && \
            ../.github/scripts/test_turbulence_model_gpu.sh gep \"GEP\" 256 512 200000 output/gpu_validation/gep && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"3. Neural Network Models\" && \
            echo \"======================================\" && \
            echo \"   3a. NN-MLP (skipping - requires model files)\" && \
            echo \"   3b. NN-TBNN (skipping - requires model files)\" && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"4. Transport Equation Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh sst \"SST k-omega\" 256 512 1000 output/gpu_validation/sst && \
            ../.github/scripts/test_turbulence_model_gpu.sh komega \"k-omega (Wilcox)\" 256 512 1000 output/gpu_validation/komega && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"5. EARSM Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_wj \"Wallin-Johansson EARSM\" 256 512 1000 output/gpu_validation/earsm_wj && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_gs \"Gatski-Speziale EARSM\" 256 512 1000 output/gpu_validation/earsm_gs && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_pope \"Pope Quadratic EARSM\" 256 512 1000 output/gpu_validation/earsm_pope && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"6. Periodic Hills - Complex Geometry\" && \
            echo \"======================================\" && \
            echo \"   6a. Baseline\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 500 --model baseline --num_snapshots 0 && \
            echo \"   6b. SST k-omega\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 1000 --model sst --num_snapshots 0 && \
            echo \"   6c. EARSM (WJ)\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 1000 --model earsm_wj --num_snapshots 0'" \
          90
    
    - name: Explicit CPU/GPU Consistency Validation
      run: |
        cd build_ci_gpu
        echo "========================================="
        echo "CPU/GPU Consistency Test (Critical)"
        echo "========================================="
        echo ""
        echo "This test validates that CPU and GPU produce IDENTICAL results."
        echo "It catches the 4 critical bugs fixed on Dec 8, 2024:"
        echo "  1. Array indexing bug (stride-based indexing)"
        echo "  2. Stale GPU data bug (sync after transport updates)"
        echo "  3. Map size mismatch bug (total_size for ghosts)"
        echo "  4. Math consistency bug (unified CPU/GPU operations)"
        echo ""
        echo "Running test_cpu_gpu_consistency..."
        echo ""
        
        ./test_cpu_gpu_consistency || {
          echo ""
          echo "╔═══════════════════════════════════════════════════════╗"
          echo "║  ✗✗✗ CRITICAL: CPU/GPU CONSISTENCY TEST FAILED ✗✗✗  ║"
          echo "╚═══════════════════════════════════════════════════════╝"
          echo ""
          echo "This indicates GPU code is producing different results than CPU!"
          echo ""
          echo "Common causes:"
          echo "  • Wrong array indexing (flat vs stride-based)"
          echo "  • Stale GPU data after CPU updates"
          echo "  • Incorrect map clause sizes"
          echo "  • Different math operations on CPU vs GPU"
          echo ""
          echo "See docs/GPU_CRITICAL_FIXES.md for details."
          echo ""
          exit 1
        }
        
        echo ""
        echo "✅ CPU/GPU consistency validated successfully"
        echo "   GPU code produces identical results to CPU code."
        echo ""
    
    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Commit: $(git rev-parse HEAD)"
        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
        echo ""
        echo "=== CMake Config Log ==="
        cat build_ci_gpu/cmake_config.log 2>/dev/null || echo "No cmake log found"
        echo ""
        echo "=== Checking compiled binaries ==="
        ls -lh build_ci_gpu/test_* 2>/dev/null || echo "No test binaries found"
        echo ""
        echo "=== Verifying source again ==="
        grep -c "k_ptr_" include/solver.hpp src/solver.cpp || echo "k_ptr_ not found!"
    
    - name: Cleanup
      if: always()
      run: rm -rf build_ci_gpu

