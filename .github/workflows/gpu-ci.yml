name: GPU CI

on:
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 150
    
    steps:
    - name: Clean workspace
      run: |
        echo "Cleaning workspace to avoid stale artifacts..."
        rm -rf ${GITHUB_WORKSPACE}/build_*
        rm -rf ${GITHUB_WORKSPACE}/CMakeCache.txt
        rm -rf ${GITHUB_WORKSPACE}/CMakeFiles
        echo "Workspace cleaned"
    
    - uses: actions/checkout@v3
    
    - name: Submit GPU correctness suite to Slurm (H200, 1 GPU)
      run: |
        set -euo pipefail
        
        SBATCH_SCRIPT="${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch"
        SLURM_OUT="${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out"
        SLURM_ERR="${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err"
        
        cat > "${SBATCH_SCRIPT}" <<'EOF'
        #!/bin/bash
        #SBATCH -J gpu-ci-correctness
        #SBATCH -A gts-sbryngelson3
        #SBATCH -N 1
        #SBATCH --ntasks-per-node=4
        #SBATCH -p gpu-h200
        #SBATCH -G 1
        #SBATCH --qos=embers
        #SBATCH -t 01:55:00
        #SBATCH -o __SLURM_OUT__
        #SBATCH -e __SLURM_ERR__
        
        set -euo pipefail
        
        module reset
        module load nvhpc
        
        cd "__WORKDIR__"
        
        # Run GPU correctness suite (Option 1 + all validation tests)
        ./.github/scripts/gpu_correctness_suite.sh "__WORKDIR__"
        
        # Run CPU-only vs GPU-offload build comparison (Option 2)
        ./.github/scripts/compare_cpu_gpu_builds.sh "__WORKDIR__"
        
        echo ""
        echo "✅ GPU Correctness Suite completed successfully"
        EOF
        
        sed -i "s|__WORKDIR__|${GITHUB_WORKSPACE}|g" "${SBATCH_SCRIPT}"
        sed -i "s|__SLURM_OUT__|${SLURM_OUT}|g" "${SBATCH_SCRIPT}"
        sed -i "s|__SLURM_ERR__|${SLURM_ERR}|g" "${SBATCH_SCRIPT}"
        
        echo "Submitting Slurm job..."
        sbatch -W "${SBATCH_SCRIPT}"
        
        echo ""
        echo "=== Slurm STDOUT ==="
        cat "${SLURM_OUT}" || true
        echo ""
        echo "=== Slurm STDERR ==="
        cat "${SLURM_ERR}" || true

    - name: Submit GPU performance suite to Slurm (H200, 1 GPU)
      run: |
        set -euo pipefail
        
        SBATCH_SCRIPT="${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch"
        SLURM_OUT="${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out"
        SLURM_ERR="${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err"
        
        cat > "${SBATCH_SCRIPT}" <<'EOF'
        #!/bin/bash
        #SBATCH -J gpu-ci-perf
        #SBATCH -A gts-sbryngelson3
        #SBATCH -N 1
        #SBATCH --ntasks-per-node=4
        #SBATCH -p gpu-h200
        #SBATCH -G 1
        #SBATCH --qos=embers
        #SBATCH -t 00:25:00
        #SBATCH -o __SLURM_OUT__
        #SBATCH -e __SLURM_ERR__
        
        set -euo pipefail
        
        module reset
        module load nvhpc
        
        cd "__WORKDIR__"
        
        # Run GPU performance suite
        ./.github/scripts/gpu_perf_suite.sh "__WORKDIR__"
        
        echo ""
        echo "✅ GPU Performance Suite completed successfully"
        EOF
        
        sed -i "s|__WORKDIR__|${GITHUB_WORKSPACE}|g" "${SBATCH_SCRIPT}"
        sed -i "s|__SLURM_OUT__|${SLURM_OUT}|g" "${SBATCH_SCRIPT}"
        sed -i "s|__SLURM_ERR__|${SLURM_ERR}|g" "${SBATCH_SCRIPT}"
        
        echo "Submitting Slurm perf job..."
        sbatch -W "${SBATCH_SCRIPT}"
        
        echo ""
        echo "=== Slurm PERF STDOUT ==="
        cat "${SLURM_OUT}" || true
        echo ""
        echo "=== Slurm PERF STDERR ==="
        cat "${SLURM_ERR}" || true
    
    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Commit: $(git rev-parse HEAD)"
        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
        echo ""
        echo "=== CMake Config Log ==="
        cat build_ci_gpu_correctness/cmake_config.log 2>/dev/null || echo "No cmake log found (correctness)"
        cat build_ci_cpu_ref/cmake_config.log 2>/dev/null || echo "No cmake log found (cpu_ref)"
        cat build_ci_gpu_perf/cmake_config.log 2>/dev/null || echo "No cmake log found (perf)"
        echo ""
        echo "=== Checking compiled binaries ==="
        ls -lh build_ci_gpu_correctness/test_* 2>/dev/null || echo "No test binaries found (correctness)"
        ls -lh build_ci_cpu_ref/test_* 2>/dev/null || echo "No test binaries found (cpu_ref)"
        ls -lh build_ci_gpu_perf/test_* 2>/dev/null || echo "No test binaries found (perf)"
        echo ""
        echo "=== Verifying source again ==="
        grep -c "k_ptr_" include/solver.hpp src/solver.cpp || echo "k_ptr_ not found!"
    
    - name: Cleanup
      if: always()
      run: |
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err || true
        rm -rf build_ci_gpu_correctness || true
        rm -rf build_ci_cpu_ref || true
        rm -rf build_ci_gpu_perf || true

