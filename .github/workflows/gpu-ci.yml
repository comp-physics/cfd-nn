name: GPU CI

on:
  push:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 90
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Make scripts executable
      run: |
        chmod +x scripts/run_gpu_ci_test.sh
        chmod +x .github/scripts/*.sh
    
    - name: Build GPU version
      run: |
        module load nvhpc/25.5
        rm -rf build_ci_gpu
        mkdir -p build_ci_gpu
        cd build_ci_gpu
        CC=nvc CXX=nvc++ cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GPU_OFFLOAD=ON
        make -j8
        mkdir -p output
    
    - name: Comprehensive GPU tests
      run: |
        cd build_ci_gpu
        ../scripts/run_gpu_ci_test.sh "all_gpu_tests" \
          "bash -c '\
            chmod +x ../.github/scripts/*.sh && \
            mkdir -p output/gpu_validation && \
            echo \"======================================\" && \
            echo \"1. Unit Tests\" && \
            echo \"======================================\" && \
            ctest --output-on-failure && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"2. Algebraic Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh baseline \"Baseline\" 256 512 10 output/gpu_validation/baseline && \
            ../.github/scripts/test_turbulence_model_gpu.sh gep \"GEP\" 256 512 10 output/gpu_validation/gep && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"3. Neural Network Models\" && \
            echo \"======================================\" && \
            echo \"   3a. NN-MLP (skipping - requires model files)\" && \
            echo \"   3b. NN-TBNN (skipping - requires model files)\" && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"4. Transport Equation Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh sst \"SST k-omega\" 256 512 20 output/gpu_validation/sst && \
            ../.github/scripts/test_turbulence_model_gpu.sh komega \"k-omega (Wilcox)\" 256 512 20 output/gpu_validation/komega && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"5. EARSM Models\" && \
            echo \"======================================\" && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_wj \"Wallin-Johansson EARSM\" 256 512 20 output/gpu_validation/earsm_wj && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_gs \"Gatski-Speziale EARSM\" 256 512 20 output/gpu_validation/earsm_gs && \
            ../.github/scripts/test_turbulence_model_gpu.sh earsm_pope \"Pope Quadratic EARSM\" 256 512 20 output/gpu_validation/earsm_pope && \
            echo \"\" && \
            echo \"======================================\" && \
            echo \"6. Periodic Hills - Complex Geometry\" && \
            echo \"======================================\" && \
            echo \"   6a. Baseline\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 20 --model baseline --num_snapshots 0 && \
            echo \"   6b. SST k-omega\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 30 --model sst --num_snapshots 0 && \
            echo \"   6c. EARSM (WJ)\" && \
            ./periodic_hills --Nx 128 --Ny 96 --nu 0.001 --max_iter 30 --model earsm_wj --num_snapshots 0'" \
          90
    
    - name: Cleanup
      if: always()
      run: rm -rf build_ci_gpu

