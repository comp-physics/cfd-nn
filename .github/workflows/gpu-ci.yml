name: GPU CI

on:
  push:

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 150
    
    steps:
    - name: Clean workspace
      run: |
        echo "Cleaning workspace to avoid stale artifacts..."
        rm -rf ${GITHUB_WORKSPACE}/build_gpu
        rm -rf ${GITHUB_WORKSPACE}/build_cpu
        rm -rf ${GITHUB_WORKSPACE}/CMakeCache.txt
        rm -rf ${GITHUB_WORKSPACE}/CMakeFiles
        echo "Workspace cleaned"
    
    - uses: actions/checkout@v3
    
    - name: Submit GPU correctness suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_correctness.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch"

    - name: Submit GPU performance suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_perf.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch"
    
    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Commit: $(git rev-parse HEAD)"
        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
        echo ""
        echo "=== Build directories ==="
        ls -la build_gpu 2>/dev/null || echo "No build_gpu directory"
        ls -la build_cpu 2>/dev/null || echo "No build_cpu directory"
        echo ""
        echo "=== Test binaries ==="
        ls -lh build_gpu/test_* 2>/dev/null || echo "No test binaries found"

    - name: Cleanup
      if: always()
      run: |
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err || true
        rm -rf build_gpu || true
        rm -rf build_cpu || true

