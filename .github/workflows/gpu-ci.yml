name: GPU CI

on:
  push:

jobs:
  gpu-tests:
    runs-on: self-hosted
    timeout-minutes: 150

    steps:
    - name: Clean workspace (preserve HYPRE cache)
      run: |
        echo "Cleaning workspace (preserving HYPRE cache)..."
        # Remove build artifacts but preserve _deps (HYPRE builds)
        # Note: ci.sh uses build_{cpu,gpu}_hypre directories when HYPRE is enabled
        for dir in build_gpu build_cpu build_gpu_hypre build_cpu_hypre; do
          if [ -d "${GITHUB_WORKSPACE}/${dir}" ]; then
            # Keep _deps, remove everything else
            find "${GITHUB_WORKSPACE}/${dir}" -mindepth 1 -maxdepth 1 ! -name '_deps' -exec rm -rf {} +
          fi
        done
        rm -rf ${GITHUB_WORKSPACE}/CMakeCache.txt
        rm -rf ${GITHUB_WORKSPACE}/CMakeFiles
        echo "Workspace cleaned (HYPRE cache preserved if present)"

    - uses: actions/checkout@v4

    # Extract HYPRE version from CMakeLists.txt to ensure cache key stays in sync
    - name: Extract HYPRE version
      id: hypre_version
      run: |
        HYPRE_VERSION=$(grep -oP 'GIT_TAG v\K[\d.]+' CMakeLists.txt || echo "unknown")
        echo "version=${HYPRE_VERSION}" >> $GITHUB_OUTPUT
        echo "Detected HYPRE version: ${HYPRE_VERSION}"

    # Cache HYPRE builds (slow to compile, rarely changes)
    # Key includes HYPRE version extracted from CMakeLists.txt and GPU architecture
    # Note: ci.sh uses build_{cpu,gpu}_hypre directories when HYPRE is enabled
    - name: Cache HYPRE builds
      uses: actions/cache@v4
      with:
        path: |
          build_cpu/_deps
          build_gpu/_deps
          build_cpu_hypre/_deps
          build_gpu_hypre/_deps
        key: hypre-v${{ steps.hypre_version.outputs.version }}-h200-cc90-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          hypre-v${{ steps.hypre_version.outputs.version }}-h200-cc90-
        save-always: true

    - name: Submit GPU correctness suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_correctness.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch"

    - name: Submit GPU performance suite to Slurm (H200, 1 GPU)
      run: |
        ./.github/scripts/submit_and_monitor_slurm.sh \
          ./.github/scripts/gpu_ci_perf.sbatch.template \
          "${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err" \
          "${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch"

    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Commit: $(git rev-parse HEAD)"
        echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
        echo ""
        echo "=== Build directories ==="
        ls -la build_gpu 2>/dev/null || echo "No build_gpu directory"
        ls -la build_cpu 2>/dev/null || echo "No build_cpu directory"
        echo ""
        echo "=== HYPRE cache status ==="
        ls -la build_gpu/_deps 2>/dev/null || echo "No GPU HYPRE cache"
        ls -la build_cpu/_deps 2>/dev/null || echo "No CPU HYPRE cache"
        echo ""
        echo "=== Test binaries ==="
        ls -lh build_gpu/test_* 2>/dev/null || echo "No test binaries found"

    - name: Cleanup (preserve HYPRE cache)
      if: always()
      run: |
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_correctness_${GITHUB_RUN_ID}.err || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.sbatch || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.out || true
        rm -f ${GITHUB_WORKSPACE}/gpu_ci_perf_${GITHUB_RUN_ID}.err || true
        # Clean build artifacts but keep _deps for cache
        # Note: ci.sh uses build_{cpu,gpu}_hypre directories when HYPRE is enabled
        for dir in build_gpu build_cpu build_gpu_hypre build_cpu_hypre; do
          if [ -d "${GITHUB_WORKSPACE}/${dir}" ]; then
            find "${GITHUB_WORKSPACE}/${dir}" -mindepth 1 -maxdepth 1 ! -name '_deps' -exec rm -rf {} +
          fi
        done
